'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _createClass=function(){function defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();var _bars=require('./barchart/bars.js'),_lines=require('./linechart/lines.js'),_slices=require('./piechart/slices.js'),_dots=require('./scatterplot/dots.js'),_svg=require('./svg'),_table=require('./table'),_axes=require('./lib/axes.js'),axes=_interopRequireWildcard(_axes),_data=require('./lib/data.js'),dataFunctions=_interopRequireWildcard(_data),_scales=require('./lib/scales.js'),scales=_interopRequireWildcard(_scales),_index=require('./forcelayout/index.js'),_index2=_interopRequireDefault(_index),_index3=require('./pack/index.js'),_index4=_interopRequireDefault(_index3),_reactPopup=require('react-popup'),_reactPopup2=_interopRequireDefault(_reactPopup),_react=require('react'),_react2=_interopRequireDefault(_react),_circle=require('./svg/circle.js');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return call&&('object'==typeof call||'function'==typeof call)?call:self}function _inherits(subClass,superClass){if('function'!=typeof superClass&&null!==superClass)throw new TypeError('Super expression must either be null or a function, not '+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}// TODO: search this file for all try catch blocks and move to separate function
/**
 * Represents a Chart
 * @constructor
 */var Chart=function(_React$Component){function Chart(a){_classCallCheck(this,Chart);/**
     * maps the chart type to required chart function
     * TODO: move to lib directory
     */var _this=_possibleConstructorReturn(this,(Chart.__proto__||Object.getPrototypeOf(Chart)).call(this,a));_initialiseProps.call(_this);var b=void 0;switch(a.chartType.toLowerCase()){case'pie':b=_slices.PieSlices;break;case'bar':b=_bars.Bars;break;case'scatterplot':b=_dots.ScatterPlotDots;break;case'line':b=_lines.Lines;break;case'table':b=_table.Table;break;case'forcedirectedgraph':b=_index2.default;break;case'pack':b=_index4.default;break;default:appFuncs.logError({data:[a.chartType,a.data],loc:__filename,msg:'did not find chart type '+a.chartType+', setting to null'}),b=null;}var c={chartFunction:b,colorScale:a.colorScaleScheme?scales.colorScale({chartDataGroupBy:a.chartDataGroupBy,colorScaleScheme:a.colorScaleScheme,colorScaleType:a.colorScaleType}):null,containerHeight:200,containerWidth:200,data:dataFunctions.format({chartDataGroupBy:a.chartDataGroupBy,chartDataSumGroupBy:a.chartDataSumGroupBy,chartType:a.chartType,data:a.data,xScaleTime:a.xScaleTime,xScaleTimeFormat:a.xScaleTimeFormat,xValue:a.xValue,yValue:a.yValue})};return _this.state=c,_this.state=c,_this}return _inherits(Chart,_React$Component),_createClass(Chart,null,[{key:'defaultProps',get:function get(){return{// required for line chart
// group data by a specific property
chartDataGroupBy:'',// if you need sum your grouped data,
// only used in line chart when chartDataGroupBy is set, i use this for displaying twitter API responses on a timeline
// the library will automatically sum your 'yValue' (e.g. total) for any grouped data with duplicate 'xValue' (e.g. date) fields and store the original values in array property 'originalDataList' field in case you're using them for something else (e.g. hover)
chartDataSumGroupBy:!1,// bar|scatterplot|pie|line|table
// scatterplot: requires x and y values to be integers
chartType:'',// one of d3 color schemes, e.g. schemeCategory10|20|20b|20c or compatible object
// @see ./lib/scales.js
colorScaleScheme:'',// one of [basic, chromatic, sequential, random]
// @see ./lib/scales.js
colorScaleType:'',// data for this chart
data:[],// used to create labels for bar charts
// @see ./lib/scales.js (passed in as 'labels' to getXScale())
datumLabels:[],// only applies to chartType='table'
// @see ./table/index.js
filterable:!1,// if this chart contains data to be embedded in a svg#foreignObject
foreignObject:!1,// the type of figure object to create, e.g. 'table' creates an html table
foreignObjectType:'table',id:'reactjs-d3-v4-universal',lineCurve:'',// used for chart margins to place scales
// @see this file and ./lib/scales.js
margins:{},// https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/preserveAspectRatio
// @see ./svg/index.js
preserveAspectRatio:'xMinYMin meet',// if chartType = 'table'
// @see ./table/index.js
sortable:!1,withDots:!1,// should we include an xAxis for this chart
// @see ./lib/aces.jjs
xAxis:!1,// the text we should use for the x axis, defaults to the xValue provided in the data
// @see ./lib/axes.js
xAxisLabel:'',// creates an X-Scale for bar, line, and scatterplot charts
xScale:!1,// required for line chart
xScaleTime:!1,// required for line chart https://github.com/d3/d3-time-format/blob/master/README.md#locale_format
// the specified format must match the format of your date string, else extra procesing will be used to convert it to the supplied/default format
xScaleTimeFormat:'%m/%d/%Y',xValue:'',// if this chart requires a y-axis
yAxis:!1,// the value to use for y axis label, defaults to
yAxisLabel:'',// if this chart requires a scale on the y dimension
yScale:!1,// used for pie chart slice arc
yValue:''}}}]),_createClass(Chart,[{key:'getChildContext',value:function getChildContext(){return{Popup:_reactPopup2.default}}},{key:'componentDidMount',value:function componentDidMount(){'table'===this.props.chartType&&(this.props.filterable&&appFuncs.filterTable.setFilterGrid(this.props.id),this.props.sortable&&appFuncs.sortTable.init()),'undefined'!=typeof window&&(window.addEventListener('resize',this.setSize,!1),window.addEventListener('orientationchange',this.setSize,!1)),this.setSize(),this.renderChart()}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(a){appFuncs._.isEqual(a.data,this.props.data)||this.setState({data:dataFunctions.format({chartDataGroupBy:a.chartDataGroupBy,chartDataSumGroupBy:a.chartDataSumGroupBy,chartType:a.chartType,data:a.data,xScaleTime:a.xScaleTime,xScaleTimeFormat:a.xScaleTimeFormat,xValue:a.xValue,yValue:a.yValue})})}},{key:'shouldComponentUpdate',value:function shouldComponentUpdate(a,b){// only update if state or props have changed
return!appFuncs._.isEqual(b,this.state)||!appFuncs._.isEqual(a,this.props)}},{key:'componentWillUnmount',value:function componentWillUnmount(){'undefined'!=typeof window&&(window.removeEventListener('resize',this.setSize),window.removeEventListener('orientationchange',this.setSize))}/**
   * retrieves container dimensions from client and updates state which triggers redraw
   *//**
   * moves SVG container into its parent
   */},{key:'render',value:function render(){return appFuncs._.isEmpty(this.props.data)?(appFuncs.logError({data:this.props.data,loc:__filename,msg:'You need data to create a chart, returning null'}),null):this.renderChart()}}]),Chart}(_react2.default.Component);Chart.propTypes={chartDataGroupBy:_react2.default.PropTypes.string,chartDataSumGroupBy:_react2.default.PropTypes.bool,chartType:_react2.default.PropTypes.string,colorScaleScheme:_react2.default.PropTypes.oneOfType([_react2.default.PropTypes.string,_react2.default.PropTypes.object]),colorScaleType:_react2.default.PropTypes.string,data:_react2.default.PropTypes.oneOfType([_react2.default.PropTypes.array,_react2.default.PropTypes.object]),datumLabels:_react2.default.PropTypes.array,filterable:_react2.default.PropTypes.bool,foreignObject:_react2.default.PropTypes.oneOfType([_react2.default.PropTypes.bool,_react2.default.PropTypes.array]),foreignObjectType:_react2.default.PropTypes.string,id:_react2.default.PropTypes.string,lineCurve:_react2.default.PropTypes.string,margins:_react2.default.PropTypes.object,preserveAspectRatio:_react2.default.PropTypes.string,sortable:_react2.default.PropTypes.bool,withDots:_react2.default.PropTypes.bool,xAxis:_react2.default.PropTypes.bool,xAxisLabel:_react2.default.PropTypes.string,xScale:_react2.default.PropTypes.bool,xScaleTime:_react2.default.PropTypes.bool,xScaleTimeFormat:_react2.default.PropTypes.string,xValue:_react2.default.PropTypes.string,yAxis:_react2.default.PropTypes.bool,yAxisLabel:_react2.default.PropTypes.string,yScale:_react2.default.PropTypes.bool,yValue:_react2.default.PropTypes.string};Chart.childContextTypes={Popup:_react2.default.PropTypes.func};var _initialiseProps=function(){var _this2=this;this.setSize=function(){var a=void 0,b=void 0;try{a=Math.min(_this2.container.offsetHeight,window.screen.height)}catch(d){a=_this2.state.containerHeight}try{b=Math.min(_this2.container.offsetWidth,window.screen.width)}catch(d){b=_this2.state.containerWidth}var c=function(){return _this2.setState({containerHeight:a,containerWidth:b}),!0};return'undefined'!=typeof window&&(window.requestAnimationFrame?window.requestAnimationFrame(c):window.setTimeout(function(){return c()},1))},this.getVisualContainerTransform=function(_ref){var a=_ref.chartHeight,b=_ref.chartType,c=_ref.chartWidth;switch(b.toLowerCase()){case'pie':return'translate('+c/2+'px, '+a/2+'px)';default:return'translate(0, 0)';}},this.renderChart=function(){// dont continue if chartFunction not valid;
if(!_this2.state.chartFunction)return null;// initialize variables required for chart
var a=_this2.state.containerHeight-(_this2.props.margins.top+_this2.props.margins.bottom),b=_this2.state.containerWidth-(_this2.props.margins.left+_this2.props.margins.right),c='undefined'!=typeof document,d=[],// eslint-disable-line
e=void 0,f=void 0,g=void 0,h=void 0;// intialize vars dependent on client
// only create X and Y axis on client
c&&(e=_this2.props.xAxis?axes.getXAxisLabel({chartDataGroupBy:_this2.props.chartDataGroupBy,transform:'rotate(0)',x:0,xAxisLabel:_this2.props.xAxisLabel||_this2.props.xValue,y:_this2.state.containerHeight}):null,f=_this2.props.xScale?scales.getXScale({chartDataGroupBy:_this2.props.chartDataGroupBy,chartHeight:a,chartType:_this2.props.chartType,chartWidth:b,data:_this2.state.data,labels:_this2.props.datumLabels,xScaleTime:_this2.props.xScaleTime,xValue:_this2.props.xValue}):null,g=_this2.props.yAxis?axes.getYAxisLabel({chartDataGroupBy:_this2.props.chartDataGroupBy,transform:'rotate(-90)',// x & y flip because of rotation
x:-a,y:'1em',yAxisLabel:_this2.props.yAxisLabel||_this2.props.yValue}):null,h=_this2.props.yScale?scales.getYScale({chartDataGroupBy:_this2.props.chartDataGroupBy,chartHeight:a,chartType:_this2.props.chartType,chartWidth:b,data:_this2.state.data,yValue:_this2.props.yValue}):null,_this2.props.yAxis&&h&&axes.getYAxis({id:_this2.props.id,thisYScale:h}),_this2.props.xAxis&&f&&axes.getXAxis({id:_this2.props.id,thisXScale:f,xScaleTime:_this2.props.xScaleTime,xScaleTimeFormat:_this2.props.xScaleTimeFormat}),_this2.props.withDots&&_this2.props.chartDataGroupBy&&f&&h&&_this2.state.data.forEach(function(k){k.values.forEach(function(l){d.push(_react2.default.createElement(_circle.Circle,{cx:f(l[_this2.props.xValue]),cy:h(l[_this2.props.yValue]),fill:_this2.state.colorScale(l[_this2.props.chartDataGroupBy]),key:''+l[_this2.props.xValue].getTime()+l[_this2.props.yValue]+l[_this2.props.chartDataGroupBy],r:4}))})}));// creates chart based on above variable initializations
var i=_this2.state.chartFunction({chartDataGroupBy:_this2.props.chartDataGroupBy,chartHeight:a,chartType:_this2.props.chartType,chartWidth:b,colorScale:_this2.state.colorScale,colorScaleScheme:_this2.props.colorScaleScheme,colorScaleType:_this2.props.colorScaleType,data:_this2.state.data,filterable:_this2.props.filterable,foreignObject:_this2.props.foreignObject,foreignObjectType:_this2.props.foreignObjectType,id:_this2.props.id,labels:_this2.props.datumLabels,lineCurve:_this2.props.lineCurve,margins:_this2.props.margins,sortable:_this2.props.sortable,xScale:f,xScaleTime:_this2.props.xScaleTime,xScaleTimeFormat:_this2.props.xScaleTimeFormat,xValue:_this2.props.xValue,yScale:h,yValue:_this2.props.yValue}),j='table'===_this2.props.chartType?i:_react2.default.createElement(_svg.SVG,{id:_this2.props.id,preserveAspectRatio:_this2.props.preserveAspectRatio,style:{position:'relative'},svgHeight:_this2.state.containerHeight,svgWidth:_this2.state.containerWidth,xmlns:'http://www.w3.org/2000/svg'},_react2.default.createElement('g',{className:'chart-svg-g',style:{height:a,transform:'translate('+_this2.props.margins.left+'px, '+_this2.props.margins.top+'px)',transition:'transform 1s',width:b}},_react2.default.createElement('g',{className:_this2.props.chartType.toLowerCase()+'-visual-container',id:_this2.props.id+'-visual-container',style:{transform:_this2.getVisualContainerTransform({chartHeight:a,chartType:_this2.props.chartType,chartWidth:b}),transition:'transform 1s'}},i,d)),_this2.props.xAxis&&_react2.default.createElement('g',{className:'x axis',style:{transform:'translate('+_this2.props.margins.left+'px, '+(a+_this2.props.margins.top)+'px)',transition:'transform 1s'}}),e,_this2.props.yAxis&&_react2.default.createElement('g',{className:'y axis',style:{transform:'translate('+_this2.props.margins.left+'px, '+_this2.props.margins.top+'px)',transition:'transform 1s'}}),g,_react2.default.createElement('text',{id:_this2.props.id+'-tooltip',style:{backgroundColor:'black',border:'2px red dashed',borderRadius:'4px',color:'black',opacity:0,padding:'10px',position:'absolute'},textAnchor:'start'}));// Create an SVG containing the chart
// Return a div containing the SVG
return _react2.default.createElement('div',{className:'chart-container',ref:function ref(k){return _this2.container=k},style:{display:'block',overflow:'hidden',position:'relative',transformOrigin:'0 0'}},_react2.default.createElement(_reactPopup2.default,null),j)}};exports.default=Chart;